variables:
  versionNumber: 1.5.0
  containerRegistry: "DockerHub.BrockSolutions"
  repository: "brocksolutions/sqlcmd"
  build: $[counter(variables['versionNumber'],0)]  # DO NOT MODIFY!

name: $(versionNumber).$(build)   # DO NOT MODIFY!

trigger:
  branches:
    include:
      - main

stages:
  - stage: DockerBuild
    displayName: "Build Container"
    dependsOn: []
    pool:
      name: SmartSuite Deployment
      demands:
        - Agent.OS -equals Linux
    jobs:
      - job: Docker_SqlCmd
        displayName: "Build & Publish Container"
        steps:
          # Available versions listed at https://download.docker.com/linux/static/stable/x86_64/
          - task: DockerInstaller@0
            displayName: "Install Docker"
            inputs:
              dockerVersion: "24.0.7"
              releaseType: stable

          # Log in to Docker Hub - Uses account stored in the Service Connection in Azure DevOps
          - task: Docker@2
            displayName: "Log In to Docker Hub"
            inputs:
              command: login
              containerRegistry: $(containerRegistry)

          # Build and Push Container
          - task: Docker@2
            displayName: "Build Container"
            inputs:
              command: build
              Dockerfile: $(Build.SourcesDirectory)/Dockerfile
              buildContext: $(Build.SourcesDirectory)
              repository: $(repository)
              tags: |
                $(Build.BuildNumber)
                latest

          - task: Docker@2
            displayName: "Push Container"
            inputs:
              command: push
              Dockerfile: $(Build.SourcesDirectory)/Dockerfile
              repository: $(repository)
              tags: |
                $(Build.BuildNumber)
                latest
